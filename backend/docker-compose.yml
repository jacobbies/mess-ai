version: '3.8'

services:
  backend:
    build:
      context: ..  # Build from parent directory
      dockerfile: backend/Dockerfile
    image: mess-ai-backend:latest
    container_name: mess-backend
    ports:
      - "8000:8000"
    environment:
      # AWS credentials (set in .env file or override)
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_REGION: ${AWS_REGION:-us-east-1}

      # S3 configuration
      S3_BUCKET: ${S3_BUCKET:-mess-ai-production}

      # Application settings
      LOG_LEVEL: ${LOG_LEVEL:-info}

    healthcheck:
      test: ["CMD", "python", "-c", "from urllib.request import urlopen; urlopen('http://localhost:8000/health', timeout=2).read()"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

    restart: unless-stopped

    # Optional: Mount for development (uncomment for hot reload)
    # volumes:
    #   - ./app:/app/app:ro

    # Optional: Override command for development
    # command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

# For local development with hot reload:
# 1. Uncomment the volumes and command sections above
# 2. Run: docker-compose up --build
#
# For production-like testing:
# 1. Keep volumes and command commented
# 2. Run: docker-compose up -d
